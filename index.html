<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI-Enhanced Incident Response System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Base styles from original with AI enhancements */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    header {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .ai-badge {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .tabs {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* AI Dashboard */
    .ai-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .ai-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .ai-card h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }

    .ai-card .metric {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }

    /* Input Group with AI */
    .input-group {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 15px;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
    }

    .ai-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #2c3e50;
    }

    .ai-toggle input[type="checkbox"] {
      transform: scale(1.3);
    }

    .ai-analysis-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-top: 15px;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-suggestion {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .ai-suggestion h4 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .response-steps {
      list-style: none;
      padding: 0;
    }

    .response-steps li {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Enhanced incident cards */
    .incident {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      padding: 20px 25px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      border-left: 5px solid #667eea;
      transition: all 0.3s ease;
      position: relative;
    }

    .incident.has-ai {
      border-left-color: #ff6b6b;
    }

    .incident.has-ai::before {
      content: "AI";
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: bold;
    }

    .ai-insights {
      background: rgba(255, 107, 107, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
      border-left: 3px solid #ff6b6b;
    }

    .ai-insights h5 {
      margin: 0 0 10px 0;
      color: #e74c3c;
      font-size: 14px;
    }

    .insight-tag {
      display: inline-block;
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin: 2px;
    }

    /* Reports section */
    .report-section {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .report-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .report-card .number {
      font-size: 28px;
      font-weight: bold;
      display: block;
    }

    /* Rest of the original styles */
    input[type="text"] {
      flex: 1;
      padding: 15px 18px;
      font-size: 16px;
      border: 2px solid transparent;
      border-radius: 12px;
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    input[type="text"]:focus {
      border-color: #667eea;
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    select {
      padding: 15px 18px;
      font-size: 16px;
      border: 2px solid transparent;
      border-radius: 12px;
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    button {
      padding: 15px 25px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .analyze-btn {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading::after {
      content: "...";
      animation: dots 1s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ""; }
      40% { content: "."; }
      60% { content: ".."; }
      80%, 100% { content: "..."; }
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .filters label {
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .filters label:hover {
      color: #667eea;
    }

    .filters input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    /* Incident List */
    .incident-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .incident-info {
      flex: 1;
    }

    .incident-info strong {
      font-size: 18px;
      color: #2c3e50;
      display: block;
      margin-bottom: 5px;
    }

    .incident-info small {
      color: #7f8c8d;
      font-size: 14px;
    }

    .priority-badge {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b6b 100%);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-left: 15px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .priority-badge.low {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }

    .priority-badge.medium {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .priority-badge.high {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .priority-badge.critical {
      background: linear-gradient(135deg, #8e44ad 0%, #732d91 100%);
      animation: pulse 2s infinite;
    }

    .incident-buttons {
      display: flex;
      gap: 10px;
    }

    .incident-buttons button {
      padding: 8px 15px;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .incident-buttons .resolve {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .incident-buttons .edit {
      background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
    }

    .incident-buttons .delete {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .incident-buttons button:hover {
      transform: translateY(-1px);
    }

    .incident-buttons button:disabled {
      background: #bbb;
      cursor: not-allowed;
      transform: none;
    }

    /* Logs Section */
    .logs-container {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 20px;
      border-radius: 15px;
      font-family: 'Courier New', monospace;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      line-height: 1.4;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .refresh-btn {
      margin-bottom: 20px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    @media (max-width: 768px) {
      .input-group {
        flex-direction: column;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        text-align: center;
      }
      
      .incident {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .incident-buttons {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

  <header>
    <div style="display: flex; align-items: center;">
      <img src="https://cdn-icons-png.flaticon.com/512/3088/3088273.png" alt="Alert Icon" style="width: 50px; height: 50px; margin-right: 15px;">
      <h1>Incident Response System<span class="ai-badge">AI-POWERED</span></h1>
    </div>
  </header>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">AI Dashboard</button>
      <button class="tab" onclick="switchTab('incidents')">Incidents</button>
      <button class="tab" onclick="switchTab('reports')">AI Reports</button>
      <button class="tab" onclick="switchTab('logs')">Activity Logs</button>
    </div>

    <!-- AI Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
      <div class="ai-dashboard" id="aiDashboard">
        <div class="ai-card">
          <h3>🚨 High Priority Open</h3>
          <div class="metric" id="highPriorityCount">0</div>
        </div>
        <div class="ai-card">
          <h3>📊 Weekly Incidents</h3>
          <div class="metric" id="weeklyCount">0</div>
        </div>
        <div class="ai-card">
          <h3>✅ Resolution Rate</h3>
          <div class="metric" id="resolutionRate">0%</div>
        </div>
        <div class="ai-card">
          <h3>🎯 Top Category</h3>
          <div class="metric" id="topCategory" style="font-size: 18px;">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Incidents Tab -->
    <div id="incidents-tab" class="tab-content">
      <!-- Incident Creation Form with AI -->
      <div class="input-group">
        <input type="text" id="desc" placeholder="Describe the incident..." />
        <select id="priority">
          <option value="">Auto (AI)</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
          <option value="Critical">Critical</option>
        </select>
        <div class="ai-toggle">
          <input type="checkbox" id="useAI" checked>
          <label for="useAI">AI Analysis</label>
        </div>
        <button onclick="analyzeIncident()" class="analyze-btn" id="analyzeBtn">Analyze</button>
        <button onclick="createIncident()">Create</button>
      </div>

      <!-- AI Analysis Panel -->
      <div id="aiAnalysisPanel" class="ai-analysis-panel">
        <h3>🤖 AI Analysis Results</h3>
        <div id="aiAnalysisContent"></div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <label>
          <input type="checkbox" id="filterResolved" onchange="fetchIncidents()">
          Show Resolved
        </label>
        <label>
          <input type="checkbox" id="filterUnresolved" checked onchange="fetchIncidents()">
          Show Unresolved
        </label>
      </div>

      <!-- Incident List -->
      <ul id="incidentList" class="incident-list"></ul>
    </div>

    <!-- AI Reports Tab -->
    <div id="reports-tab" class="tab-content">
      <div class="report-section">
        <h2>📈 AI-Generated Summary Report</h2>
        <button onclick="generateReport()" style="background: rgba(255,255,255,0.2);">Generate Latest Report</button>
        <div class="report-grid" id="reportContent">
          <div class="report-card">
            <span class="number">Loading...</span>
            <div>Generating Report</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <button class="refresh-btn" onclick="fetchLogs()">Refresh Logs</button>
      <div id="logsContainer" class="logs-container">
        <div class="log-entry">Loading logs...</div>
      </div>
    </div>

  </div>

  <script>
    let currentAIAnalysis = null;

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      if (tabName === 'dashboard') {
        loadDashboard();
      } else if (tabName === 'logs') {
        fetchLogs();
      } else if (tabName === 'reports') {
        generateReport();
      } else if (tabName === 'incidents') {
        fetchIncidents();
      }
    }

    // Load AI Dashboard
    async function loadDashboard() {
      try {
        const response = await fetch('/insights');
        const insights = await response.json();
        
        document.getElementById('highPriorityCount').textContent = insights.alerts.high_priority_open;
        document.getElementById('weeklyCount').textContent = insights.trends.weekly_incidents;
        document.getElementById('resolutionRate').textContent = insights.trends.resolution_rate + '%';
        document.getElementById('topCategory').textContent = insights.alerts.categories_most_affected;
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('highPriorityCount').textContent = 'Error';
        document.getElementById('weeklyCount').textContent = 'Error';
        document.getElementById('resolutionRate').textContent = 'Error';
        document.getElementById('topCategory').textContent = 'Error';
      }
    }

    // Analyze incident with AI
    async function analyzeIncident() {
      const description = document.getElementById('desc').value.trim();
      const analyzeBtn = document.getElementById('analyzeBtn');
      const panel = document.getElementById('aiAnalysisPanel');
      
      if (!description) {
        alert('Please enter an incident description first');
        return;
      }

      // Show loading state
      analyzeBtn.classList.add('loading');
      analyzeBtn.textContent = 'Analyzing';
      
      try {
        const formData = new FormData();
        formData.append('description', description);
        
        const response = await fetch('/incidents/analyze', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          currentAIAnalysis = await response.json();
          displayAIAnalysis(currentAIAnalysis);
          panel.style.display = 'block';
          
          // Auto-fill priority if not set
          const prioritySelect = document.getElementById('priority');
          if (!prioritySelect.value) {
            prioritySelect.value = currentAIAnalysis.suggested_priority;
          }
        } else {
          throw new Error('Analysis failed');
        }
      } catch (error) {
        console.error('AI Analysis error:', error);
        alert('AI analysis failed. Please try again.');
      } finally {
        analyzeBtn.classList.remove('loading');
        analyzeBtn.textContent = 'Analyze';
      }
    }

    // Display AI analysis results
    function displayAIAnalysis(analysis) {
      const content = document.getElementById('aiAnalysisContent');
      
      const html = `
        <div class="ai-suggestion">
          <h4>📊 Priority Assessment</h4>
          <p><strong>Suggested Priority:</strong> <span class="insight-tag">${analysis.suggested_priority}</span></p>
          <p><strong>Category:</strong> <span class="insight-tag">${analysis.category}</span></p>
          <p><strong>Risk Level:</strong> <span class="insight-tag">${analysis.risk_level}</span></p>
        </div>
        
        <div class="ai-suggestion">
          <h4>🛠️ Recommended Response Steps</h4>
          <ul class="response-steps">
            ${analysis.response_steps.map(step => `<li>${step}</li>`).join('')}
          </ul>
        </div>
        
        <div class="ai-suggestion">
          <h4>⏰ Analysis Timestamp</h4>
          <p>${analysis.analysis_timestamp}</p>
        </div>
      `;
      
      content.innerHTML = html;
    }

    // Create incident with AI analysis
    async function createIncident() {
      const description = document.getElementById('desc').value.trim();
      const priority = document.getElementById('priority').value;
      const useAI = document.getElementById('useAI').checked;
      
      if (!description) {
        alert('Please enter an incident description');
        return;
      }
      
      const formData = new FormData();
      formData.append('description', description);
      formData.append('priority', priority);
      formData.append('use_ai', useAI);
      
      try {
        const response = await fetch('/incidents', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          document.getElementById('desc').value = '';
          document.getElementById('priority').value = '';
          document.getElementById('aiAnalysisPanel').style.display = 'none';
          currentAIAnalysis = null;
          fetchIncidents();
          loadDashboard(); // Refresh dashboard
          alert('Incident created successfully!');
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        console.error('Error creating incident:', error);
        alert('Failed to create incident');
      }
    }

    // Fetch incidents from server
    async function fetchIncidents() {
      const resolvedFilter = document.getElementById('filterResolved').checked;
      const unresolvedFilter = document.getElementById('filterUnresolved').checked;

      try {
        const response = await fetch('/incidents');
        const incidents = await response.json();

        // Filter incidents based on checkboxes
        let filteredIncidents = incidents.filter(incident => {
          if (!resolvedFilter && !unresolvedFilter) return false;
          if (resolvedFilter && incident.resolved) return true;
          if (unresolvedFilter && !incident.resolved) return true;
          return false;
        });

        // Sort incidents by priority and date
        filteredIncidents.sort((a, b) => {
          const priorityOrder = { Critical: 4, High: 3, Medium: 2, Low: 1 };
          const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
          if (priorityDiff !== 0) return priorityDiff;
          return new Date(b.created_at) - new Date(a.created_at);
        });

        renderIncidents(filteredIncidents);
      } catch (error) {
        console.error('Error fetching incidents:', error);
        document.getElementById('incidentList').innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error loading incidents</div>';
      }
    }

    // Render incidents list
    function renderIncidents(incidents) {
      const container = document.getElementById('incidentList');
      container.innerHTML = '';

      if (incidents.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d; font-size: 18px;">No incidents found</div>';
        return;
      }

      incidents.forEach((incident) => {
        const li = document.createElement('li');
        li.className = `incident ${incident.resolved ? 'resolved' : ''} ${incident.ai_analysis ? 'has-ai' : ''}`;
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';

        // Incident Info
        const infoDiv = document.createElement('div');
        infoDiv.className = 'incident-info';
        infoDiv.innerHTML = `
          <strong>${incident.description}</strong>
          <span class="priority-badge ${incident.priority.toLowerCase()}">${incident.priority}</span>
          <br>
          <small>Created: ${incident.created_at}${incident.resolved_at ? ' | Resolved: ' + incident.resolved_at : ''}</small>
        `;

        // Add AI insights if available
        if (incident.ai_analysis) {
          const aiInsights = document.createElement('div');
          aiInsights.className = 'ai-insights';
          aiInsights.innerHTML = `
            <h5>🤖 AI Analysis</h5>
            <span class="insight-tag">Category: ${incident.ai_analysis.category}</span>
            <span class="insight-tag">Risk: ${incident.ai_analysis.risk_level}</span>
            <br>
            <small style="color: #666; margin-top: 5px; display: block;">
              ${incident.ai_analysis.response_steps ? incident.ai_analysis.response_steps.slice(0, 2).join(', ') + '...' : ''}
            </small>
          `;
          infoDiv.appendChild(aiInsights);
        }

        li.appendChild(infoDiv);

        // Incident Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'incident-buttons';

        const editButton = document.createElement('button');
        editButton.className = 'edit';
        editButton.textContent = 'Edit';
        editButton.onclick = () => {
          const newDesc = prompt('Update description:', incident.description);
          if (newDesc !== null && newDesc.trim()) updateIncident(incident.id, newDesc);
        };
        buttonsDiv.appendChild(editButton);

        const resolveButton = document.createElement('button');
        resolveButton.className = 'resolve';
        resolveButton.textContent = incident.resolved ? 'Resolved' : 'Resolve';
        resolveButton.disabled = incident.resolved;
        resolveButton.onclick = () => resolveIncident(incident.id);
        buttonsDiv.appendChild(resolveButton);

        const deleteButton = document.createElement('button');
        deleteButton.className = 'delete';
        deleteButton.textContent = 'Delete';
        deleteButton.onclick = () => {
          if (confirm('Are you sure you want to delete this incident?')) {
          deleteIncident(incident.id);
        }
      };
      buttonsDiv.appendChild(deleteButton);

      li.appendChild(buttonsDiv);
      container.appendChild(li);
    });
  }

  // Update incident
  async function updateIncident(id, newDescription) {
    const formData = new FormData();
    formData.append('description', newDescription);
    formData.append('reanalyze', 'true'); // Request AI re-analysis
    
    try {
      const response = await fetch(`/incidents/${id}`, {
        method: 'PUT',
        body: formData
      });
      
      if (response.ok) {
        fetchIncidents();
        loadDashboard(); // Refresh dashboard
        alert('Incident updated successfully!');
      } else {
        const error = await response.json();
        alert('Error: ' + error.error);
      }
    } catch (error) {
      console.error('Error updating incident:', error);
      alert('Failed to update incident');
    }
  }

  // Resolve incident
  async function resolveIncident(id) {
    try {
      const response = await fetch(`/incidents/${id}/resolve`, {
        method: 'PATCH'
      });
      
      if (response.ok) {
        fetchIncidents();
        loadDashboard(); // Refresh dashboard
        alert('Incident resolved!');
      } else {
        const error = await response.json();
        alert('Error: ' + error.error);
      }
    } catch (error) {
      console.error('Error resolving incident:', error);
      alert('Failed to resolve incident');
    }
  }

  // Delete incident
  async function deleteIncident(id) {
    try {
      const response = await fetch(`/incidents/${id}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        fetchIncidents();
        loadDashboard(); // Refresh dashboard
        alert('Incident deleted!');
      } else {
        const error = await response.json();
        alert('Error: ' + error.error);
      }
    } catch (error) {
      console.error('Error deleting incident:', error);
      alert('Failed to delete incident');
    }
  }

  // Generate AI report
  async function generateReport() {
    const reportContent = document.getElementById('reportContent');
    reportContent.innerHTML = '<div class="report-card"><span class="number">Loading...</span><div>Generating Report</div></div>';
    
    try {
      const response = await fetch('/reports/summary');
      const report = await response.json();
      
      const html = `
        <div class="report-card">
          <span class="number">${report.summary.total_incidents}</span>
          <div>Total Incidents</div>
        </div>
        <div class="report-card">
          <span class="number">${report.summary.resolved_incidents}</span>
          <div>Resolved</div>
        </div>
        <div class="report-card">
          <span class="number">${report.summary.open_incidents}</span>
          <div>Open</div>
        </div>
        <div class="report-card">
          <span class="number">${report.summary.resolution_rate}%</span>
          <div>Resolution Rate</div>
        </div>
        <div class="report-card">
          <span class="number">${report.recent_activity.incidents_last_7_days}</span>
          <div>Last 7 Days</div>
        </div>
        <div class="report-card">
          <span class="number">${report.recent_activity.average_per_day}</span>
          <div>Avg/Day</div>
        </div>
      `;
      
      reportContent.innerHTML = html;
    } catch (error) {
      console.error('Error generating report:', error);
      reportContent.innerHTML = '<div class="report-card"><span class="number">Error</span><div>Failed to load</div></div>';
    }
  }

  // Fetch logs
  async function fetchLogs() {
    const container = document.getElementById('logsContainer');
    container.innerHTML = '<div class="log-entry">Loading logs...</div>';
    
    try {
      const response = await fetch('/logs');
      const data = await response.json();
      
      if (data.logs && data.logs.length > 0) {
        container.innerHTML = '';
        data.logs.reverse().forEach(log => {
          const logDiv = document.createElement('div');
          logDiv.className = 'log-entry';
          logDiv.textContent = log;
          container.appendChild(logDiv);
        });
      } else {
        container.innerHTML = '<div class="log-entry">No logs available</div>';
      }
    } catch (error) {
      console.error('Error fetching logs:', error);
      container.innerHTML = '<div class="log-entry">Error loading logs</div>';
    }
  }

  // Initialize the application
  document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    fetchIncidents();
    
    // Auto-refresh dashboard every 30 seconds
    setInterval(() => {
      if (document.querySelector('.tab.active').textContent === 'AI Dashboard') {
        loadDashboard();
      }
    }, 30000);
  });

  // Handle AI toggle
  document.getElementById('useAI').addEventListener('change', function() {
    const panel = document.getElementById('aiAnalysisPanel');
    if (!this.checked) {
      panel.style.display = 'none';
      currentAIAnalysis = null;
    }
  });

  // Auto-analyze on Enter key
  document.getElementById('desc').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('useAI').checked) {
      analyzeIncident();
    }
  });
  </script>

</body>
</html>